/*
 * Copyright (c) 2016, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License./
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function getPieMark(a,b){var c;if("donut"==a.mode)var c=a.width/5;else var c=0;var d={type:"arc",from:{data:a.title},properties:{update:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5},startAngle:{field:"layout_start"},endAngle:{field:"layout_end"},innerRadius:{value:c},outerRadius:{value:.4*a.width},fill:{scale:"color",field:b.names[a.color]},fillOpacity:{value:1}},hover:{fillOpacity:{value:.8}}}};return d}function getPieText(a,b){var c={type:"text",from:{data:a.title},properties:{update:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5},radius:{value:.5*a.width},theta:{field:"layout_mid"},fill:{value:"#000"},align:{value:"center"},baseline:{value:"middle"},text:{field:b.names[a.x],mult:.5}}}};return c}function getAreaMark(a,b){var c={type:"area",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},y2:{scale:"y",value:0},fill:{value:a.markColor},strokeWidth:{value:2},fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}};return c}function getBarMark(a,b){var c={type:"rect",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},width:{scale:"x",band:!0,offset:-1},y:{scale:"y",field:b.names[a.y]},y2:{scale:"y",value:0},fill:{value:"steelblue"},fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}};return c}function getStackBarMark(a,b){var c={type:"rect",from:{data:"table",transform:[{type:"stack",groupby:[b.names[a.x]],sortby:[b.names[a.color]],field:b.names[a.y]}]},properties:{update:{x:{scale:"x",field:b.names[a.x]},width:{scale:"x",band:!0,offset:-1},y:{scale:"y",field:"layout_start"},y2:{scale:"y",field:"layout_end"},fill:{scale:"color",field:b.names[a.color]},fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}};return c}function getLineMark(a,b){var c;return c=-1!=a.color?{type:"group",from:{data:a.title,transform:[{type:"facet",groupby:[b.names[a.color]]}]},marks:[{type:"line",properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},stroke:{scale:"color",field:b.names[a.color]},strokeWidth:{value:2},strokeOpacity:{value:1}},hover:{strokeOpacity:{value:.5}}}}]}:{type:"line",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},stroke:{value:a.markColor},strokeWidth:{value:2},strokeOpacity:{value:1}},hover:{strokeOpacity:{value:.5}}}}}function getTopoJson(a,b){var c,d=a.width,e=a.height,f=a.charts[0].mapType,g="mercator";"usa"==f?(d=a.width-160,e=a.height-130,c=a.height+270,g="albersUsa"):"europe"==f?(d=(a.width/2+100)/2,e=a.height+150,c=a.height+50):(c=a.width/640*120,d=a.width/2+10,e=a.height/2+40);var h=a.geoCodesUrl,i={name:"geoData",url:h,format:{type:"topojson",feature:"units"},transform:[{type:"geopath",value:"data",scale:c,translate:[d,e],projection:g},{type:"lookup",keys:["id"],on:a.title,onKey:b.names[a.x],as:["zipped"],"default":{v:null,country:"No data"}}]};return i}function getMapMark(a,b){var c=[{name:"map",type:"path",from:{data:"geoData"},properties:{enter:{path:{field:"layout_path"}},update:{fill:{rule:[{predicate:{name:"isNotNull",id:{field:"zipped.v"}},scale:"color",field:"zipped.v"},{value:"grey"}]}},hover:{fill:{value:"#989898"}}}},{type:"group",from:{data:a.title,transform:[{type:"filter",test:"datum."+b.names[a.x]+" == tooltipSignal.datum."+b.names[a.x]}]},properties:{update:{x:{signal:"tooltipSignal.x",offset:-5},y:{signal:"tooltipSignal.y",offset:20},width:{value:a.toolTip.width},height:{value:a.toolTip.height},fill:{value:a.toolTip.color}}},marks:[{type:"text",properties:{update:{x:{value:6},y:{value:14},text:{template:"{{tooltipSignal.datum.unitName}} {{tooltipSignal.datum.v}}"},fill:{value:"black"}}}}]}];return c}function getMapSignals(){var a=[{name:"tooltipSignal",init:{expr:"{x: 0, y: 0, datum: {} }"},streams:[{type:"@map:mouseover",expr:"{x: eventX(), y: eventY(), datum: eventItem().datum.zipped}"},{type:"@map:mouseout",expr:"{x: 0, y: 0, datum: {} }"}]}];return a}function getMapPredicates(){var a={name:"isNotNull",type:"!=",operands:[{value:null},{arg:"id"}]};return a}function getMapLegends(a,b){var c={fill:"color",title:b.names[a.y],properties:{gradient:{stroke:{value:"transparent"}},title:{fontSize:{value:14}},legend:{x:{value:0},y:{value:a.height-40}}}};return c}function loadGeoMapCodes(a){var b,c=new XMLHttpRequest;return c.overrideMimeType("application/json"),c.open("GET",a,!1),c.onreadystatechange=function(){4==c.readyState&&"200"==c.status&&(b=JSON.parse(c.responseText))},c.send(null),b}function getMapCode(a,b,c){if("world"==b||"europe"==b)for(d=0;d<c.length;d++)a.toUpperCase()==c[d].name.toUpperCase()&&(a=c[d]["alpha-3"]);else{var d=0;for(var e in c)c.hasOwnProperty(e)&&a.toUpperCase()==e.toUpperCase()&&(a="US"+c[e]),d++}return a}function getScatterMark(a,b){var c={type:"symbol",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},fill:{scale:"color",field:b.names[a.color]},size:{scale:"size",field:b.names[a.size]},fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}};return c}function getScatterToolTipMark(a,b){a.toolTip.height=50,a.toolTip.y=-50;var c=getToolTipMark(a,b),d={type:"text",properties:{update:{x:{value:6},y:{value:44},text:{template:"Size 	 ("+b.names[a.size]+") 	 {{hover."+b.names[a.size]+"}}"},fill:{value:"black"}}}};return c.marks.push(d),c}function checkConfig(a,b){return null==a.title&&(a.title="table"),null==a.xTitle&&(a.xTitle=a.x),null==a.yTitle&&(a.yTitle=a.y),null==a.colorScale&&(a.colorScale="category10"),null==a.grid&&(a.grid=!0),null==a.zero&&(a.zero=!1),null==a.color?a.color=-1:"*"!=a.color&&(a.color=b.names.indexOf(a.color)),null==a.mapType&&(a.mapType=-1),null==a.minColor&&(a.minColor=-1),null==a.maxColor&&(a.maxColor=-1),null==a.mode&&(a.mode="stack"),null==a.size?a.size=-1:a.size=b.names.indexOf(a.size),null==a.maxLength&&(a.maxLength=-1),null==a.markColor&&(a.markColor="steelblue"),null==a.markSize&&(a.markSize=2),null==a.fillOpacity&&(a.fillOpacity=1),null==a.renderer&&(a.renderer="canvas"),null==a.toolTip&&(a.toolTip={height:35,width:120,color:"#e5f2ff",x:0,y:-30}),null==a.padding&&(a.padding={top:50,left:60,bottom:40,right:150}),null==a.hoverType&&(a.hoverType="symbol"),null==a.tooltip&&(a.tooltip=!0),a.x=b.names.indexOf(a.x),a.y=b.names.indexOf(a.y),a}function buildTable(a){var b={};return b.metadata=a[0].metadata,b.values=buildData(a[0].data,a[0].metadata),b}function buildData(a,b){for(chartData=[],i=0;i<a.length;i++){var c={};for(x=0;x<b.names.length;x++)c[b.names[x]]=a[i][x];chartData.push(c)}return chartData}function getSymbolMark(a,b){var c;c=-1!=a.color?{scale:"color",field:b.names[a.color]}:{value:a.markColor};var d={type:"symbol",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},fill:c,size:{value:a.markSize},fillOpacity:{value:a.fillOpacity}}}};return d}function getSignals(a,b){var c=[{name:"hover",init:{},streams:[{type:a.hoverType+":mouseover",expr:"datum"},{type:a.hoverType+":mouseout",expr:"{}"}]}];return c}function bindTooltip(a,b,c,d,e,f){c.on("mouseover",function(c,g){if(null!=g&&"exit"!=g.status&&g.mark.marktype==b){var h=$(".marks")[0];$("#wrapper #tip").length&&$tip.remove(),$(a).wrap("<div id='wrapper' style='position: relative'></div>"),$("#wrapper").append("<div id='tip' class='tooltipClass' style='top:0; left: 0; position: absolute'></div>"),$tip=$("#tip"),$tip.empty();var i=g.datum,j="";for(var k in i)if(i.hasOwnProperty(k))if(void 0!=f){for(var l=0;l<f.length;l++)for(var m in d)if(m==f[l]&&e.names[d[m]]==k){j+="<p>"+f[l]+" ("+k+"):"+i[k]+"</p>";break}}else e.names[d.x]==k&&(j+="<p>X ("+k+"):"+i[k]+"</p>"),e.names[d.y]==k&&(j+="<p>Y ("+k+"):"+i[k]+"</p>");$tip.append(j);var n=h.width,o=h.height,p=$('.marks[style*="width"]');p.length>0&&(n=parseFloat($(".marks")[0].style.width),o=parseFloat($(".marks")[0].style.height));var q,r=$tip.width(),s=$tip.height(),t=g.bounds.x2+d.padding.left+r,u=o-g.bounds.y2-d.padding.top+s,v=g.bounds.y2+d.padding.top-s;q=t>n?g.bounds.x2+d.padding.left-r:g.bounds.x2+d.padding.left,u>o&&(v=g.bounds.y2+d.padding.top),$tip.css({left:q,top:v}).show()}else $("#wrapper #tip").length&&$tip.remove(),$(a).closest("#wrapper").length&&$(a).unwrap()})}var arc=function(a,b){this.metadata=a[0].metadata;var c=[];this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title,a[0].transform=[{type:"pie",field:this.metadata.names[b.x]}];var d=[];null==b.colorDomain&&(b.colorDomain={data:b.title,field:this.metadata.names[b.color]});var e={name:"color",type:"ordinal",domain:b.colorDomain,range:b.colorScale};d.push(e),c.push(getPieMark(b,this.metadata)),c.push(getPieText(b,this.metadata));var f="Legend";"table"!=b.title&&(f=b.title);var g=[{fill:"color",title:"Legend",offset:20,properties:{symbols:{fillOpacity:{value:.5},stroke:{value:"transparent"}}}}];this.spec.legends=g,this.spec.width=b.width,this.spec.height=b.height,this.spec.data=a,this.spec.scales=d,this.spec.padding=b.padding,this.spec.marks=c};arc.prototype.draw=function(a,b){var c=function(c){if(this.view=c({el:a}).renderer(this.config.renderer).update(),null!=b)for(var d=0;d<b.length;d++)this.view.on(b[d].type,b[d].callback)}.bind(this);if(-1!=this.config.maxLength){var d=this.spec.data[0].values,e=this.config.maxLength;if(d.length>=this.config.maxLength){for(var f=[],g=d.length-e,h=g;h<d.length;h++)f.push(d[h]);this.spec.data[0].values=f}}vg.parse.spec(this.spec,c)},arc.prototype.insert=function(a){var b=this.metadata.names[this.config.color],c=this.metadata.names[this.config.x],d=this.view,e=!1;for(i=0;i<a.length;i++)this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},c,function(b){return e=!0,a[i][c]});0==e&&d.data(this.config.title).insert(a),this.view.update({duration:500})},arc.prototype.getSpec=function(){return this.spec};var area=function(a,b){this.metadata=a[0].metadata;var c=[];this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title;var d={name:"x",type:this.metadata.types[b.x],range:"width",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.x]}},e={name:"y",type:this.metadata.types[b.y],range:"height",zero:"false",domain:{data:b.title,field:this.metadata.names[b.y]}},f=[d,e],g=[{type:"x",scale:"x",grid:b.grid,title:b.xTitle},{type:"y",scale:"y",grid:b.grid,title:b.yTitle}];c.push(getAreaMark(b,this.metadata)),b.fillOpacity=0,b.markSize=1e3,c.push(getSymbolMark(b,this.metadata)),this.spec.width=b.width,this.spec.height=b.height,this.spec.axes=g,this.spec.data=a,this.spec.scales=f,this.spec.padding=b.padding,this.spec.marks=c};area.prototype.draw=function(a,b){var c=function(c){if(this.view=c({el:a}).renderer(this.config.renderer).update(),0!=this.config.tooltip&&bindTooltip(a,"symbol",this.view,this.config,this.metadata),null!=b)for(var d=0;d<b.length;d++)this.view.on(b[d].type,b[d].callback)}.bind(this);if(-1!=this.config.maxLength){var d=this.spec.data[0].values,e=this.config.maxLength;if(d.length>=this.config.maxLength){for(var f=[],g=d.length-e,h=g;h<d.length;h++)f.push(d[h]);this.spec.data[0].values=f}}vg.parse.spec(this.spec,c)},area.prototype.insert=function(a){if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+a.length){var b=function(a){return a[this.metadata.names[this.config.x]]==c}.bind(this);for(i=0;i<a.length;i++){var c=this.view.data(this.config.title).values()[i][this.metadata.names[this.config.x]];this.view.data(this.config.title).remove(b)}}this.view.data(this.config.title).insert(a),this.view.update()},area.prototype.getSpec=function(){return this.spec};var bar=function(a,b){this.metadata=a[0].metadata;var c=[],d=[];this.spec={};var e,f;if(b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title,-1!=b.color){var g={name:"stack",source:b.title,transform:[{type:"aggregate",groupby:[this.metadata.names[b.x]],summarize:[{field:this.metadata.names[b.y],ops:["sum"]}]}]},h="Legend";"table"!=b.title&&(h=b.title),a.push(g),null==b.colorDomain&&(b.colorDomain={data:b.title,field:this.metadata.names[b.color]});var i={name:"color",type:"ordinal",domain:b.colorDomain,range:b.colorScale};d.push(i);var j=[{fill:"color",title:"Legend",offset:0,properties:{symbols:{fillOpacity:{value:.5},stroke:{value:"transparent"}}}}];this.spec.legends=j,e="sum_"+this.metadata.names[b.y],f="stack"}else e=this.metadata.names[b.y],f=b.title;var k={name:"x",type:"ordinal",range:"width",domain:{data:b.title,field:this.metadata.names[b.x]}},l={name:"y",type:this.metadata.types[b.y],range:"height",domain:{data:f,field:e}};d.push(k),d.push(l);var m=[{type:"x",scale:"x",grid:b.grid,title:b.xTitle},{type:"y",scale:"y",grid:b.grid,title:b.yTitle}];-1!=b.color&&"stack"==b.mode?c.push(getStackBarMark(b,this.metadata)):c.push(getBarMark(b,this.metadata)),this.spec.width=b.width,this.spec.height=b.height,this.spec.axes=m,this.spec.data=a,this.spec.scales=d,this.spec.padding=b.padding,this.spec.marks=c;JSON.stringify(this.spec)};bar.prototype.draw=function(a,b){var c=function(c){if(this.view=c({el:a}).renderer(this.config.renderer).update(),0!=this.config.tooltip&&bindTooltip(a,"rect",this.view,this.config,this.metadata),null!=b)for(var d=0;d<b.length;d++)this.view.on(b[d].type,b[d].callback)}.bind(this);if(-1!=this.config.maxLength){var d=this.spec.data[0].values,e=this.config.maxLength;if(d.length>=this.config.maxLength){for(var f=[],g=d.length-e,h=g;h<d.length;h++)f.push(d[h]);this.spec.data[0].values=f}}vg.parse.spec(this.spec,c)},bar.prototype.insert=function(a){var b=this.metadata.names[this.config.x],c=this.metadata.names[this.config.y],d=(this.metadata.names[this.config.size],this.metadata.names[this.config.color]);if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+a.length){var e=this.view.data(this.config.title).values().concat(a),f=[];for(i=0;i<e.length-this.config.maxLength;i++)f.push(this.view.data(this.config.title).values()[i][b]);for(i=0;i<a.length;i++){var g=!1;if(this.view.data(this.config.title).update(function(c){var e;e=-1==d?c[b]==a[i][b]:c[b]==a[i][b]&&c[d]==a[i][d]},c,function(b){return g=!0,a[i][c]}),g){var h=!1,j=f.indexOf(a[i][b]);j>-1&&(h=!0,f.splice(j,1)),h||f.splice(f.length-1,1)}else this.view.data(this.config.title).insert([a[i]]),this.view.update()}var k,l=function(a){return a[b]==k};for(i=0;i<f.length;i++)k=f[i],this.view.data(this.config.title).remove(l)}else for(i=0;i<a.length;i++){var g=!1;this.view.data(this.config.title).update(function(c){var e;e=-1==d?c[b]==a[i][b]:c[b]==a[i][b]&&c[d]==a[i][d]},c,function(b){return g=!0,a[i][c]}),g||this.view.data(this.config.title).insert([a[i]])}this.view.update({duration:200})},bar.prototype.getSpec=function(){return this.spec};var vizg=function(a,b){if(a=buildTable(a),"undefined"!=typeof b.charts&&1==b.charts.length){for(var c in b.charts[0])b.charts[0].hasOwnProperty(c)&&(b[c]=b.charts[0][c]);this.chart=new window[b.type]([a],b)}};vizg.prototype.draw=function(a,b){this.chart.draw(a,b)},vizg.prototype.insert=function(a){this.chart.insert(buildData(a,this.chart.metadata))},vizg.prototype.getSpec=function(){return this.chart.getSpec()};var line=function(a,b){this.metadata=a[0].metadata;var c=[];this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title;var d={name:"x",type:this.metadata.types[b.x],range:"width",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.x]}},e={name:"y",type:this.metadata.types[b.y],range:"height",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.y]}},f=[d,e];if(-1!=b.color){null==b.colorDomain&&(b.colorDomain={data:b.title,field:this.metadata.names[b.color]});var g={name:"color",type:"ordinal",domain:b.colorDomain,range:b.colorScale};f.push(g)}var h=[{type:"x",scale:"x",grid:b.grid,title:b.xTitle},{type:"y",scale:"y",grid:b.grid,title:b.yTitle}];if(c.push(getLineMark(b,this.metadata)),b.markSize=20,c.push(getSymbolMark(b,this.metadata)),-1!=b.color){var i="Legend";"table"!=b.title&&(i=b.title);var j=[{fill:"color",title:"Legend",offset:0,properties:{symbols:{fillOpacity:{value:.5},stroke:{value:"transparent"}}}}];this.spec.legends=j}this.spec.width=b.width,this.spec.height=b.height,this.spec.axes=h,this.spec.data=a,this.spec.scales=f,this.spec.padding=b.padding,this.spec.marks=c};line.prototype.draw=function(a,b){var c=function(c){if(this.view=c({el:a}).renderer(this.config.renderer).update(),0!=this.config.tooltip&&bindTooltip(a,"symbol",this.view,this.config,this.metadata),null!=b)for(var d=0;d<b.length;d++)this.view.on(b[d].type,b[d].callback)}.bind(this);if(-1!=this.config.maxLength){var d=this.spec.data[0].values,e=this.config.maxLength;if(d.length>=this.config.maxLength){for(var f=[],g=d.length-e,h=g;h<d.length;h++)f.push(d[h]);this.spec.data[0].values=f}}vg.parse.spec(this.spec,c)},line.prototype.insert=function(a){if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+a.length){var b=function(a){return a[this.metadata.names[this.config.x]]==c}.bind(this);for(i=0;i<a.length;i++){var c=this.view.data(this.config.title).values()[i][this.metadata.names[this.config.x]];this.view.data(this.config.title).remove(b)}}this.view.data(this.config.title).insert(a),this.view.update()},line.prototype.getSpec=function(){return this.spec};var map=function(a,b){this.metadata=a[0].metadata;var c,d,e=[],f=[];this.spec={};var g;for(g=loadGeoMapCodes(b.helperUrl),b=checkConfig(b,this.metadata),this.config=b,this.config.geoInfoJson=g,b.toolTip.height=20,b.toolTip.width=100,i=0;i<a[0].values.length;i++)for(var h in a[0].values[i])if(h==a[0].metadata.names[b.x]&&a[0].values[i].hasOwnProperty(h)){a[0].values[i].unitName=a[0].values[i][h],a[0].values[i][h]=getMapCode(a[0].values[i][h],b.mapType,g);break}a[0].name=b.title,a[0].transform=[{type:"formula",field:"v",expr:"datum."+this.metadata.names[b.y]}],b.tooltip&&(c=getMapMark(b,this.metadata),d=getMapSignals(),this.spec.signals=d),a.push(getTopoJson(b,this.metadata)),e.push(getMapPredicates()),f.push(getMapLegends(b,this.metadata));var j={name:"color",type:"linear",domain:{data:"geoData",field:"zipped.v"},domainMin:0,zero:!1,range:["#FFEDBC","#f83600"]},k=[j];this.spec.width=b.width,this.spec.height=b.height,this.spec.data=a,this.spec.scales=k,this.spec.padding=b.padding,this.spec.marks=c,this.spec.predicates=e,this.spec.legends=f};map.prototype.draw=function(a,b){var c=function(c){if(this.view=c({el:a}).renderer(this.config.renderer).update(),null!=b)for(var d=0;d<b.length;d++)this.view.on(b[d].type,b[d].callback)}.bind(this);vg.parse.spec(this.spec,c)},map.prototype.insert=function(a){var b=this.metadata.names[this.config.x],c=this.metadata.names[this.config.y],d=this.metadata.names[this.config.color],e=this.config.mapType,f=this.config.geoInfoJson;for(i=0;i<a.length;i++)for(var g in a[i])if(g==b&&a[i].hasOwnProperty(g)){a[i].unitName=a[i][g],a[i][g]=getMapCode(a[i][g],e,f);break}for(i=0;i<a.length;i++){var h=!1;this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},c,function(b){return h=!0,a[i][c]}),this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},d,function(b){return h=!0,a[i][d]}),h||this.view.data(this.config.title).insert([a[i]])}this.view.update()};var number=function(a,b){this.metadata=a[0].metadata,this.data=a[0].values;this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title};number.prototype.draw=function(a){a=a.replace("#","");var b=a+"Content",c="";null!=this.data&&0!=this.data.length&&(c=this.data[this.data.length-1][this.metadata.names[this.config.x]]);var d="<p style='padding: 0px 0px 0px 20px;'>"+this.config.title+"</p><br/><p align='center' style='font-size:60px;padding: 0px 0px 0px 20px;' id='"+b+"'>"+c+"</p>";document.getElementById(a).innerHTML=d,this.view=b},number.prototype.insert=function(a){document.getElementById(this.view).innerHTML=a[a.length-1][this.metadata.names[this.config.x]]};var scatter=function(a,b){this.metadata=a[0].metadata;var c=[];this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title;var d={name:"x",type:this.metadata.types[b.x],range:"width",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.x]}},e={name:"y",type:this.metadata.types[b.y],range:"height",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.y]}},f={name:"size",type:"linear",range:[0,576],domain:{data:b.title,field:this.metadata.names[b.size]}},g={name:"color",type:"linear",range:[b.minColor,b.maxColor],domain:{data:b.title,field:this.metadata.names[b.color]}},h=[d,e,f,g],i=[{type:"x",scale:"x",grid:b.grid,title:b.xTitle},{type:"y",scale:"y",grid:b.grid,title:b.yTitle}];c.push(getScatterMark(b,this.metadata)),this.spec.width=b.width,this.spec.height=b.height,this.spec.axes=i,this.spec.data=a,this.spec.scales=h,this.spec.padding=b.padding,this.spec.marks=c};scatter.prototype.draw=function(a,b){var c=function(c){if(this.view=c({el:a}).renderer(this.config.renderer).update(),0!=this.config.tooltip&&bindTooltip(a,"symbol",this.view,this.config,this.metadata,["x","y","size"]),null!=b)for(var d=0;d<b.length;d++)this.view.on(b[d].type,b[d].callback)}.bind(this);if(-1!=this.config.maxLength){var d=this.spec.data[0].values,e=this.config.maxLength;if(d.length>=this.config.maxLength){for(var f=[],g=d.length-e,h=g;h<d.length;h++)f.push(d[h]);this.spec.data[0].values=f}}vg.parse.spec(this.spec,c)},scatter.prototype.insert=function(a){var b=this.metadata.names[this.config.x],c=this.metadata.names[this.config.y],d=this.metadata.names[this.config.size],e=this.metadata.names[this.config.color];if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+a.length){var f=this.view.data(this.config.title).values().concat(a),g=[];for(i=0;i<f.length-this.config.maxLength;i++)g.push(this.view.data(this.config.title).values()[i][b]);for(i=0;i<a.length;i++){var h=!1;if(this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},c,function(b){return h=!0,a[i][c]}),this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},e,function(b){return h=!0,a[i][e]}),this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},d,function(b){return h=!0,a[i][d]}),h){var j=!1,k=g.indexOf(a[i][b]);k>-1&&(j=!0,g.splice(k,1)),j||g.splice(g.length-1,1)}else this.view.data(this.config.title).insert([a[i]]),this.view.update()}var l,m=function(a){return a[b]==l};for(i=0;i<g.length;i++)l=g[i],this.view.data(this.config.title).remove(m)}else for(i=0;i<a.length;i++){var h=!1;this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},c,function(b){return h=!0,a[i][c]}),this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},e,function(b){return h=!0,a[i][e]}),this.view.data(this.config.title).update(function(c){return c[b]==a[i][b]},d,function(b){return h=!0,a[i][d]}),h||this.view.data(this.config.title).insert([a[i]])}this.view.update({duration:200})},scatter.prototype.getSpec=function(){return this.spec};var table=function(a,b){this.metadata=a[0].metadata,this.data=a[0].values;this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title};table.prototype.draw=function(a){var b=d3.select(a).append("table").attr("class","table table-bordered").attr("id",this.config.title);b.append("thead").attr("align","center").append("tr").selectAll("th").data(this.config.columnTitles).enter().append("th").text(function(a){return a}),b.append("tbody").attr("id","tableChart-"+this.config.title),this.setupData(this.data,this.config),b.selectAll("thead th").text(function(a){return a.charAt(0).toUpperCase()+a.substr(1)})},table.prototype.insert=function(a){this.setupData(a,this.config)},table.prototype.setupData=function(a,b){for(var c=[],d=this.metadata.names,e=0;e<a.length;e++){for(var f={},g=0;g<b.columns.length;g++)f[b.columns[g]]=a[e][b.columns[g]];c.push(f)}var h=d3.select("#tableChart-"+b.title).selectAll("tr").data(c,function(a){return a[b.key]}),i=h.enter().append("tr").selectAll("td").data(function(a){return b.columns.map(function(b){return{column:b,value:a[b]}})}).enter().append("td");-1!=b.color&&d3.select("#tableChart-"+b.title).selectAll("td").attr("bgcolor",function(a){var c=a.key||a.column;if("string"==typeof a.value);else if("*"==b.color||c==d[b.color]){var e;e="string"==typeof b.colorScale?window.d3.scale[b.colorScale]().range():b.colorScale;for(var f,g=0;g<d.length;g+=1)d[g]===c&&(f=g);var h=d3.scale.linear().range(["#f2f2f2",e[f]]).domain([d3.min(d3.select("#tableChart-"+b.title).selectAll("tr").data(),function(a){return a[c]}),d3.max(d3.select("#tableChart-"+b.title).selectAll("tr").data(),function(a){return a[c]})]);return h(a.value)}}),i.append("span");var j=h.selectAll("td").style({padding:"0px 10px 0px 10px"}).data(function(a){return d3.map(a).entries()}).attr("class",function(a){return a.key});if(j.select("span").text(function(a){return a.value}),-1!=b.maxLength&&d3.select("tbody").selectAll("tr").data().length>b.maxLength){var k=d3.select("tbody").selectAll("tr").data().slice(d3.select("tbody").selectAll("tr").data().length-b.maxLength,b.maxLength);d3.select("tbody").selectAll("tr").data(k,function(a){return a}).remove()}};